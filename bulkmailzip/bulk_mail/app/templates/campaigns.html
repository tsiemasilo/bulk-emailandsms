{% extends base %}
{% block head_extra %}
<style>
.label {
font-weight: bold;
}
</style>
{% endblock %}

{% block content %}
{% import "macros/action_icons_static.html" as icons with context %}
<span class="title"><h2>{% block title %}Campaigns{% endblock %}</h2></span>
<div class="content-container content">
{% if campaigns %}
<div class="table-container table-unified">
<table class="data-table" id="tbl_campaigns">
<thead>
<tr class="table-header-row-unified">
<th colspan="4">
<div class="table-header-content">
<h3>Campaigns</h3>
<div class="table-header-actions">
<button type="button" id="btn_add_campaign" class="action-btn" value="Add Campaign" title="Add Campaign">
<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
<span>Add Campaign</span>
</button>
</div>
</div>
</th>
</tr>
<tr>
<th>Reference Number</th><th>Title</th><th>Description</th><th>Actions</th>
</tr>
</thead>
<tbody>
{% for campaign in campaigns %}
<tr>
<td>{{ campaign.v_reference_number }}</td><td>{{ campaign.v_campaign_title }}</td><td>{{ campaign.v_description }}</td>
<td id="td_{{ campaign.id }}">
<button type="button" class="btn_edit_campaign btn-icon" value="Campaign Basics" title="Campaign Basics" aria-label="Campaign Basics">
<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
</button>
<button type="button" class="btn_remove_campaign btn-icon" value="Remove Campaign" title="Remove Campaign" aria-label="Remove Campaign">
<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
</button>
<button type="button" class="btn_campaign_sending btn-icon" value="Campaign Sending" title="Campaign Sending" aria-label="Campaign Sending">
<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
</button>
</td>
</tr>
{% endfor %}{# end of looping through campaigns #}
</tbody>
</table><!-- end of tbl_campaigns -->
</div><!-- end of div.table-container -->
{% from "macros/paging.html" import paging_basics with context %}
{{ paging_basics() }}
{% else %}
<div class="table-container table-unified">
<table class="data-table" id="tbl_campaigns">
<thead>
<tr class="table-header-row-unified">
<th colspan="4">
<div class="table-header-content">
<h3>Campaigns</h3>
<div class="table-header-actions">
<button type="button" id="btn_add_campaign" class="action-btn" value="Add Campaign" title="Add Campaign">
<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
<span>Add Campaign</span>
</button>
</div>
</div>
</th>
</tr>
<tr>
<th>Reference Number</th><th>Title</th><th>Description</th><th>Actions</th>
</tr>
</thead>
<tbody>
<tr>
<td colspan="4">No campaigns found. Click "Add Campaign" to create one.</td>
</tr>
</tbody>
</table>
</div>
{% endif %}{# end of checking if campaigns existed #}
</div><!-- end of div.content -->
{% from "macros/dialog.html" import dlg_prep with context %}
{{ dlg_prep(["dlg_campaign"]) }}
{# dlg divs below #}
<div id="dlg_campaign" aria-labeledby="spn_campaign">
<span id="spn_campaign">campaign details</span><br>
<form action="{{ url_for("main.campaigns") }}" method="post" id="frm_campaign">
{{ form.csrf_token }}
<input type="hidden" name="hid_page" id="hid_page" value="{{ page }}">
{{ form.hid_campaign_id }}
<ul>
<li>{{ form.txt_reference_number.label }}&nbsp;{{ form.txt_reference_number }}</li>
<li>{{ form.txt_campaign_title.label }}&nbsp;{{ form.txt_campaign_title }}</li>
<li>{{ form.txt_description.label }}<br>
{{ form.txt_description }}</li>
<li>{{ form.sel_email_id.label }}{{ form.sel_email_id }}</li>
<li>{{ form.d_target.label }}&nbsp;{{ form.d_target }}</li>
<li>{{ form.t_target.label }}&nbsp;{{ form.t_target }}</li>
<li><button type="button" id="btn_target_immediate" value="Set to Immediate">{{ icons.settings_svg(s_label="Set to Immediate") }}>Set to Immediate</button></li>
<li>{{ form.sel_company_email_address_id.label }}{{ form.sel_company_email_address_id }}</li>
<li>{{ form.txt_email_from.label }}{{ form.txt_email_from(readonly=true) }}</li>
<li>{{ form.txt_email_reply_to.label }}{{ form.txt_email_reply_to }}</li>
</ul>
<input type="submit" name="btn_save_campaign" value="Save">
</form>
</div><!-- end of dlg_campaign -->
<script type="text/javascript">
$(document).ready( function() {

try {

var s_dlg_campaign = $("#dlg_campaign").html();

$("#btn_add_campaign").click( function() {
    $("#dlg_campaign").html(s_dlg_campaign);
    $("#dlg_campaign").redraw();
    $("#dlg_campaign").dialog("open");
    $("#txt_reference_number").focus();
});// end of #btn_add_campaign click event

$("#tbl_campaigns").on("click", "button.btn_edit_campaign", function() {
try {
    var td_parent = $(this).parent();
    var s_id = String($(td_parent).attr("id")).replace("td_", "");
    $("#dlg_campaign").html(s_dlg_campaign);
    $("#dlg_campaign").redraw();
    var s_url = "{{ url_for("main.campaign_details", i_campaign_id=99999) }}".replace("99999", s_id);
    $.get(s_url, function(o_data) {
        if (typeof(o_data)=="object") {
            var s_reference_number = String(o_data.v_reference_number);
            var s_campaign_title = String(o_data.v_campaign_title);
            var s_description = String(o_data.v_description)
            var s_email_id = String(o_data.i_email_id);
            var i_company_email_address_id = String(o_data.i_company_email_address_id);
            var s_email_from = String(o_data.v_email_from);
            var s_email_reply_to = String(o_data.v_email_reply_to);
            $("#hid_campaign_id").val(s_id);
            $("#txt_reference_number").val(s_reference_number);
            $("#txt_campaign_title").val(s_campaign_title);
            $("#txt_description").val(s_description);
            $("#sel_email_id").val(s_email_id);
            $("#d_target").val(o_data.d_target);
            $("#t_target").val(o_data.t_target);
            $("#sel_company_email_address_id").val(i_company_email_address_id);
            $("#txt_email_from").val(s_email_from);
            $("#txt_email_reply_to").val(s_email_reply_to);
            $("#dlg_campaign").redraw();
            $("#dlg_campaign").dialog("open");
            $("#txt_reference_number").focus();
        } else {
            do_alert(String(o_data));
        }// end of typeof check against o_data
    });// end of .get
} catch(e) {
    var s_err = String(e.name) + "\nmessage:" + String(e.message);
    s_err = (typeof(e.lineNumber)!="undefined") ? s_err + "\nline:" + String(e.lineNumber) : s_err;
    alert("Error! " + s_err);
}//end of catch
});// end of .btn_edit_campaign click event inside tbl_campaigns

$("#tbl_campaigns").on("click", "button.btn_remove_campaign", function() {
try {
    var td_parent = $(this).parent();
    var s_id = String($(td_parent).attr("id")).replace("td_", "");
    var bl_confirm = confirm("Are you sure?");
    if (bl_confirm) {
        $("#hid_remove_campaign_id").val(s_id);
        document.getElementById("frm_remove_campaign").submit();
    }// end of confirmation check
} catch(e) {
    var s_err = String(e.name) + "\nmessage:" + String(e.message);
    s_err = (typeof(e.lineNumber)!="undefined") ? s_err + "\nline:" + String(e.lineNumber) : s_err;
    alert("Error! " + s_err);
}//end of catch
});// end of .btn_remove_campaign click event inside tbl_campaigns

function jump_page(i_page) {
    i_page = (isNaN(i_page)) ? 1 : Number(i_page);
    $("#hid_page").val(i_page);
    document.getElementById("frm_paging").submit();
}// end of jump_page function

$(".a_page_number").click( function(event) {
    event.preventDefault();
    var s_page = String($(this).attr("href")).replace("#", "");
    i_page = (isNaN(s_page)) ? 1 : Number(s_page);
    jump_page(i_page);
});// end of .a_page_number function

$("#tbl_campaigns").on("click", "button.btn_campaign_sending", function() {
    var s_id = $($(this).parent()).attr("id").replace("td_", "");
    var s_url = "{{ url_for("main.campaign_sending", i_campaign_id=99999) }}".replace("99999", s_id);
    window.location.assign(s_url);
});// end of .btn_campaign_sending click event

var ar_email_reply_to = {};
{% for email_reply in email_reply_to_addresses %}
ar_email_reply_to["{{ email_reply.id }}"] = ["{{ email_reply.v_email_address }}", "{{ email_reply.v_reply_to_address }}"];
{% endfor %}

$("#dlg_campaign").on("change", "#sel_company_email_address_id", function(event) {
    if ($(this).prop("selectedIndex")>0) {
        var o_opt = $(this).find(":selected");
        var opt_id = $(o_opt).val();
        $("#txt_email_from").val(ar_email_reply_to[opt_id][0]);
        $("#txt_email_reply_to").val(ar_email_reply_to[opt_id][1]);
    } else {
        $("#txt_email_from").val("");
        $("#txt_reply_to").val("");
    }// end of making sure option after first placeholder is selected
});// end of change event on sel_company_email_address_id inside dlg_campaign

$("#btn_target_immediate").click( function(event) {
try {
    var s_date_immediate = Date();
    $("#d_target").val(s_date_immediate);
    $("#t_target").val(s_date_immediate);
} catch(e) {
    var s_err = String(e.name) + "\nmessage:" + String(e.message);
    s_err = (typeof(e.lineNumber)!="undefined") ? s_err + "\nline:" + String(e.lineNumber) : s_err;
    alert("Error! " + s_err);
}//end of catch
});// end of btn_target_immediate click event

window.setTimeout( function() {
    var s_nada = ""; //alert("hello world");
}, 300);
var s = "nada"; // do_alert("hello world");

} catch(e) {
    var s_err = String(e.name) + "\nmessage:" + String(e.message);
    s_err = (typeof(e.lineNumber)!="undefined") ? s_err + "\nline:" + String(e.lineNumber) : s_err;
    alert("Error! " + s_err);
}//end of catch

});// end of secondary document ready
</script>
<form action="{{ url_for("main.campaigns") }}" method="post" id="frm_paging">
<input type="hidden" name="hid_page" id="hid_page" value="{{ page }}">
</form>
{% if remove_form %}
<form action="{{ url_for("main.campaigns") }}" method="post" id="frm_remove_campaign">
{{ remove_form.csrf_token }}
<input type="hidden" name="hid_page" id="hid_page" value="{{ page }}">
{{ remove_form.hid_remove_campaign_id }}
</form>
{% endif %}
{% endblock %}